<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Redactar contrato ‚Äî La Marquesina</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="./style.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="./script.js"></script>
  <script defer src="./popups-loader.js"></script>
  <style>
    .hidden{display:none}
    .note { font-size:.9rem; color:#666 }
  </style>
</head>
<body class="bg" onload="protectPage()">
  <header class="bar">
    <div class="brand">
      <img src="./img/logo.png" alt="La Marquesina" class="logo">
      <h1>Redactar contrato</h1>
    </div>
    <nav class="nav">
      <a href="./dashboard.html" class="btn">Panel</a>
      <a href="./ver.html" class="btn">Ver contratos</a>
      
      <button class="btn danger" onclick="openLogoutPopup()">Cerrar sesi√≥n</button>
      
    </nav>
  </header>

  <main class="wrap">
    <form id="contractForm" class="card stack">
      <h2 class="subtitle">Datos del contrato</h2>
      <div id="popups-root"></div>
      <!-- Tipo -->
      <label>Tipo de contrato</label>
      <select id="tipo" required>
        <option value="">Selecciona el tipo de contrato</option>
        <option value="barman">Barman</option>
        <option value="catering">Catering</option>
        <option value="ambos">Ambos</option>
      </select>

      <!-- Servicios Barman -->
      <div id="serviciosBarman" class="section">
        <h3>Servicios (Barman)</h3>
        <label><input type="checkbox" class="barmanCheck" value="Barman" checked> Barman</label>
        <label><input type="checkbox" class="barmanCheck" value="Ayudante de barra"> Ayudante de barra</label>
        <label><input type="checkbox" class="barmanCheck" value="Barra m√≥vil"> Barra m√≥vil</label>
        <div class="row">
          <div class="col">
            <label>Cocteles</label>
            <select id="coctelesTipo" required>
              <option value="">Seleccionar. tipo de vaso</option>
              <option value="Acr√≠lico">Acr√≠lico</option>
              <option value="Cristaler√≠a">Cristaler√≠a</option>
            </select>
          </div>
          <div class="col">
            <label>Variedades</label>
            <div class="chips">
              <label><input type="checkbox" name="cocteles" value="Pisco Sour"> Pisco Sour</label>
              <label><input type="checkbox" name="cocteles" value="Jamaiquila"> Jamaiquila</label>
              <label><input type="checkbox" name="cocteles" value="Machu Picchu"> Machu Picchu</label>
              <label><input type="checkbox" name="cocteles" value="Cuba Libre"> Cuba Libre</label>
              <label><input type="checkbox" name="cocteles" value="Caipirinha"> Caipirinha</label>
              <label><input type="checkbox" name="cocteles" value="Tequila Sunrise"> Tequila Sunrise</label>
              <label><input type="checkbox" name="cocteles" value="Pi√±a Colada"> Pi√±a Colada</label>
              <label><input type="checkbox" name="cocteles" value="Blue Hawaiian"> Blue Hawaiian</label>
              <label><input type="checkbox" name="cocteles" value="Pantera Rosa"> Pantera Rosa</label>
              <label><input type="checkbox" name="cocteles" value="Daiquiri de Fruta"> Daiquiri de Fruta</label>
              <label><input type="checkbox" name="cocteles" value="Algarrobina"> Algarrobina</label>
              <label><input type="checkbox" name="cocteles" value="The Dirty Shirley"> The Dirty Shirley</label>
              <label><input type="checkbox" name="cocteles" value="Mojito de Fruta"> Mojito de Fruta</label>
              <label><input type="checkbox" name="cocteles" value="Mojito Cl√°sico"> Mojito Cl√°sico</label>
              <label><input type="checkbox" name="cocteles" value="Dark &amp; Stormy"> Dark &amp; Stormy</label>
              <label><input type="checkbox" name="cocteles" value="Chilcano de Fruta"> Chilcano de Fruta</label>
              <label><input type="checkbox" name="cocteles" value="Chilcano Cl√°sico"> Chilcano Cl√°sico</label>
              <label><input type="checkbox" name="cocteles" value="Blue Long Island"> Blue Long Island</label>
            </div>
          </div>
        </div>

        <!-- Cantidades de cocteles -->
        <div class="row" style="margin-top:8px">
          <div class="col">
            <label>¬øUsar cantidades separadas?</label>
            <select id="coctelesModo">
              <option value="total">Una sola cantidad total</option>
              <option value="separado">Separar por Acr√≠lico / Cristaler√≠a</option>
            </select>
          </div>
          <div class="col" id="coctelesTotalWrap">
            <label>Cant. total de cocteles</label>
            <input type="number" id="coctelesCantidadTotal" placeholder="Cantidad total de cocteles" min="1" />
          </div>
          <div class="col hidden" id="coctelesSepWrap">
            <div class="row" style="gap:10px">
              <div class="col">
                <label>Cant. Acr√≠lico</label>
                <input type="number" id="coctelesAcrilico" min="0" placeholder="Cantidad en acr√≠lico" />
              </div>
              <div class="col">
                <label>Cant. Cristaler√≠a</label>
                <input type="number" id="coctelesCristaleria" min="0" placeholder="Cantidad en cristaler√≠a" />
              </div>
            </div>
          </div>
        </div>
        <p class="note">Precio autom√°tico Barman: S/. 3.00 (acr√≠lico) ‚Ä¢ S/. 4.50 (cristaler√≠a)</p>
      </div>

      <!-- Servicios Catering -->
      <div id="serviciosCatering" class="section hidden">
        <h3>Servicios (Catering)</h3>

        <!-- Platos de sitio -->
        <label>
          <input type="checkbox" id="chkPlatosSitio" class="cateringCheck" value="Platos de sitio">
          Platos de sitio
        </label>
        <div class="row hidden" id="platosOpts">
          <div class="col">
            <label>Color platos de sitio</label>
            <select id="colorPlatos">
              <option value="">Selecciona el color</option>
              <option value="Dorado">Dorado</option>
              <option value="Rojo">Rojo</option>
              <option value="Azul">Azul</option>
              <option value="Plateado">Plateado</option>
              <option value="otro">Otro‚Ä¶</option>
            </select>
          </div>
          <div class="col hidden" id="colorPlatosOtroWrap">
            <label>Especificar color</label>
            <input type="text" id="colorPlatosOtro" placeholder="Ej.: Vino tinto" />
          </div>
        </div>
<br>
        <!-- Servilletas -->
        <label>
          <input type="checkbox" id="chkServilletas" class="cateringCheck" value="Servilletas">
          Servilletas
        </label>
        <div class="row hidden" id="servilletasOpts">
          <div class="col">
            <label>Color servilletas</label>
            <select id="colorServilletas">
              <option value="">Selecciona el color</option>
              <option value="Blanco">Blanco</option>
              <option value="Rojo">Rojo</option>
              <option value="Azul">Azul</option>
              <option value="Negro">Negro</option>
              <option value="otro">Otro‚Ä¶</option>
            </select>
          </div>
          <div class="col hidden" id="colorServilletasOtroWrap">
            <label>Especificar color</label>
            <input type="text" id="colorServilletasOtro" placeholder="Ej.: Marfil" />
          </div>
        </div>
<br>
        <!-- Cantidad de mesas (si hay Platos de sitio o Servilletas) -->
        <div class="row hidden" id="mesasWrap">
          <div class="col">
            <label>Cantidad de mesas</label>
            <input type="number" id="cantidadMesas" min="1" placeholder="Ingresar Cantidad de mesas" />
          </div>
        </div>
<br>
        <!-- Otros servicios -->
        <label><input type="checkbox" id="chkCopas" class="cateringCheck" value="Copas"> Copas</label>
        <label><input type="checkbox" id="chkCubiertos" class="cateringCheck" value="Cubiertos dorados"> Cubiertos dorados</label>

        <!-- Mozos -->
        <label>
          <input type="checkbox" id="chkMozos" class="cateringCheck" value="Mozos">
          Mozos
        </label>
        <div class="row hidden" id="mozosWrap">
          <div class="col">
            <label>Cantidad de mozos</label>
            <input type="number" id="cantidadMozos" min="1" placeholder="Ingresar Cantidad de mozos" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Cantidad de platos</label>
            <input type="number" id="cantidadCatering" placeholder="Ingresa Cantidad de platos" min="1" required />
          </div>
          <div class="col" id="precioPlatoWrap">
            <label>Precio por plato (S/.)</label>
            <input type="number" id="precioPlato" min="0" step="0.01" placeholder="Precio por cada plato" />
          </div>
          <div class="col">
            <label>Comida (describir)</label>
            <input type="text" id="platosDescripcion" placeholder="Ej: pollo enrollado" required />
          </div>
        </div>
      </div>

      <!-- Totales -->
      <div class="row">
        <div class="col hidden" id="wrapSubtotalBarman">
          <label>Total cocteles (S/.)</label>
          <input type="number" id="subtotalBarman" min="0" step="0.01" readonly />
        </div>
        <div class="col hidden" id="wrapSubtotalComida">
          <label>Total comida (S/.)</label>
          <input type="number" id="subtotalComida" min="0" step="0.01" readonly />
        </div>
        <div class="col">
          <label>Total (S/.)</label>
          <input type="number" id="total" min="0" step="0.01" placeholder="Se calcula autom√°ticamente" readonly />
        </div>
        <div class="col">
          <label>Adelanto (S/.)</label>
          <input type="number" id="adelanto" min="0" step="0.01" placeholder="Ingresar Adelanto Recibido" required />
        </div>
        <div class="col">
          <label>Resta (S/.)</label>
          <input type="number" id="resta" min="0" step="0.01" placeholder="Resta autom√°tica" readonly />
        </div>
      </div>
      <p class="note" id="detalleTotalesNote"></p>

      <!-- Movilidad con monto -->
      <div class="row" style="margin-top:8px">
        <div class="col">
          <label><input type="checkbox" id="movOn"> Incluir movilidad</label>
        </div>
        <div class="col hidden" id="movMontoWrap">
          <label>Monto de movilidad (S/.)</label>
          <input type="number" id="movilidadMonto" placeholder="Costo de la movilidad" min="0" step="0.01" />
        </div>
      </div>

      <!-- Evento -->
      <label>Selecciona fecha y hora‚Ä¶</label>
      <div class="grid-2">
        <div class="field">
          <label>Fecha del evento</label>
          <input class="input" type="date" id="fecha" required />
        </div>
        <div class="field" id="horaGeneralField">
          <label>Hora (AM/PM)</label>
          <div class="time-12">
            <input class="input" id="horaH" type="number" min="1" max="12" required />
            <span>:</span>
            <input class="input" id="horaM" type="number" min="0" max="59" step="1" required />
            <select class="select" id="horaAP">
              <option>PM</option>
              <option>AM</option>
            </select>
          </div>
          <div style="margin-top:6px">
            <label><input type="checkbox" id="horaIndefinida"> Hora por definir</label>
          </div>
          <input type="hidden" id="hora" />
        </div>
      </div>

      <p class="muted" id="previewFechaHora">Selecciona fecha y hora‚Ä¶</p>

            <!-- Horas espec√≠ficas por tipo -->
            <div class="section">
        <h3>Horas espec√≠ficas</h3>
        <div class="grid-2">
          <!-- Hora comida (catering) -->
          <div class="field" id="horaComBlock">
            <label>Hora comida (catering)</label>
            <div class="time-12">
              <input class="input" id="horaComH" type="number" min="1" max="12" />
              <span>:</span>
              <input class="input" id="horaComM" type="number" min="0" max="59" step="1" />
              <select class="select" id="horaComAP">
                <option>PM</option>
                <option>AM</option>
              </select>
            </div>
            <div style="margin-top:6px">
              <label><input type="checkbox" id="horaComIndef"> Hora de comida por definir</label>
            </div>
          </div>

          <!-- Hora cocteles (barman) -->
          <div class="field" id="horaCockBlock">
            <label>Hora cocteles (barman)</label>
            <div class="time-12">
              <input class="input" id="horaCockH" type="number" min="1" max="12" />
              <span>:</span>
              <input class="input" id="horaCockM" type="number" min="0" max="59" step="1" />
              <select class="select" id="horaCockAP">
                <option>PM</option>
                <option>AM</option>
              </select>
            </div>
            <div style="margin-top:6px">
              <label><input type="checkbox" id="horaCockIndef"> Hora de cocteles por definir</label>
            </div>
          </div>
        </div>
      </div>



      <!-- Ubicaci√≥n -->
      <div class="row">
        <div class="col">
          <label>Direcci√≥n</label>
          <input type="text" id="direccion" placeholder="Escribe la direcci√≥n completa" required />
        </div>
        <div class="col">
          <label>Referencia (opcional)</label>
          <input type="text" id="referencia" placeholder="Referencia (opcional)" />
        </div>
      </div>

      <!-- Contratante -->
      <div class="row">
        <div class="col">
          <label>Nombre del contratante</label>
          <input type="text" id="contratante" placeholder="Nombre y apellido del contratante" required />
        </div>
        <div class="col">
          <label>DNI</label>
          <input type="text" id="dni" placeholder="DNI de 8 d√≠gitos" required pattern="[0-9]{8}" title="Debe tener 8 d√≠gitos" />
        </div>
      </div>

      <!-- Extras (para cualquier tipo) -->
      <div class="section">
        <h3>Extras</h3>
        <textarea id="extras" rows="3" placeholder="Notas adicionales, condiciones especiales, etc."></textarea>
      </div>

      <!-- Firmas -->
      <div id="firmasSegunTipo" class="section">
        <h3>Firmas</h3>
        <div id="firmaCatering" class="hidden">
          <label>Firma para Catering</label>
          <select id="firmaCateringSelect" required>
            <option value="">Seleccionar quien hizo el contrato</option>
            <option value="Rosario">Rosario</option>
            <option value="Sujey">Sujey</option>
          </select>
        </div>
        <div id="firmaBarman">
          <p>Para Barman: Rosario y Sebasti√°n.</p>
        </div>
        <div id="firmaAmbos" class="hidden">
          <p>Para Ambos: espacio para firma del contratante.</p>
        </div>
      </div>

      <!-- Botones -->
      <div class="row gap">
        <button type="submit" class="btn primary">üìÑ Crear y Guardar Contrato</button>
        
      </div>

      <p id="saveMsg" class="ok hidden">Guardado correctamente.</p>
      <p id="saveErr" class="error"></p>
    </form>
  </main>

  <!-- ======== Scripts de la p√°gina ======== -->
  <script>
    // Calcula "Resta"
    (function(){
      const total = document.getElementById('total');
      const adelanto = document.getElementById('adelanto');
      const resta = document.getElementById('resta');
      function upd(){ const t=parseFloat(total.value||0), a=parseFloat(adelanto.value||0); resta.value=(t-a).toFixed(2); }
      total.addEventListener('input', upd); adelanto.addEventListener('input', upd);
    })();

    // Normaliza: aseg√∫rate de que todos los checkboxes de variedades tengan class="varCoctel"
(function ensureVarCoctelClass(){
  document.querySelectorAll("input[name='cocteles']").forEach(el => {
    el.classList.add("varCoctel");
  });
})();


    // Mostrar/ocultar colores + mesas seg√∫n checkbox (IDs corregidos) + manejo de "Otro"
    (function(){
      const chkPlatos = document.getElementById('chkPlatosSitio');
      const platosOpts = document.getElementById('platosOpts');
      const selPlatos = document.getElementById('colorPlatos');
      const platosOtroWrap = document.getElementById('colorPlatosOtroWrap');
      const platosOtro = document.getElementById('colorPlatosOtro');

      const chkServ = document.getElementById('chkServilletas');
      const servilletasOpts = document.getElementById('servilletasOpts');
      const selServ = document.getElementById('colorServilletas');
      const servOtroWrap = document.getElementById('colorServilletasOtroWrap');
      const servOtro = document.getElementById('colorServilletasOtro');

      const mesasWrap = document.getElementById('mesasWrap');
      const cantidadMesas = document.getElementById('cantidadMesas');

      const chkMozos = document.getElementById('chkMozos');
      const mozosWrap = document.getElementById('mozosWrap');
      const cantidadMozos = document.getElementById('cantidadMozos');

      function toggleWrap(chk, wrap, sel){
        wrap.classList.toggle('hidden', !chk.checked);
        if (sel){
          if (chk.checked) sel.setAttribute('required','');
          else sel.removeAttribute('required');
        }
      }
      function toggleMesas(){
        const show = chkPlatos.checked || chkServ.checked;
        mesasWrap.classList.toggle('hidden', !show);
        if (show) cantidadMesas.setAttribute('required','');
        else cantidadMesas.removeAttribute('required');
      }
      function toggleMozos(){
        mozosWrap.classList.toggle('hidden', !chkMozos.checked);
        if (chkMozos.checked) cantidadMozos.setAttribute('required','');
        else cantidadMozos.removeAttribute('required');
      }
      function toggleOtro(selectEl, wrapEl, inputEl){
        const isOtro = selectEl.value === 'otro';
        wrapEl.classList.toggle('hidden', !isOtro);
        if (isOtro) { inputEl.setAttribute('required',''); }
        else { inputEl.removeAttribute('required'); inputEl.value=''; }
      }

      chkPlatos.addEventListener('change', () => { toggleWrap(chkPlatos, platosOpts, selPlatos); toggleMesas(); });
      chkServ.addEventListener('change', () => { toggleWrap(chkServ, servilletasOpts, selServ); toggleMesas(); });
      chkMozos.addEventListener('change', toggleMozos);

      selPlatos.addEventListener('change', () => toggleOtro(selPlatos, platosOtroWrap, platosOtro));
      selServ.addEventListener('change', () => toggleOtro(selServ, servOtroWrap, servOtro));

      toggleWrap(chkPlatos, platosOpts, selPlatos);
      toggleWrap(chkServ, servilletasOpts, selServ);
      toggleMesas();
      toggleMozos();
    })();

    // Unifica secciones y required por tipo
    // Unifica secciones y required por tipo
(function(){
  const tipoEl = document.getElementById("tipo");
  const secBarman = document.getElementById("serviciosBarman");
  const secCatering = document.getElementById("serviciosCatering");
  const firmaBarman = document.getElementById("firmaBarman");
  const firmaCatering = document.getElementById("firmaCatering");
  const firmaAmbos = document.getElementById("firmaAmbos");

  const coctelesTipo  = document.getElementById("coctelesTipo");
  const coctelesModo  = document.getElementById("coctelesModo");
  const totalWrap     = document.getElementById("coctelesTotalWrap");
  const sepWrap       = document.getElementById("coctelesSepWrap");
  const totalEl       = document.getElementById("coctelesCantidadTotal");
  const acEl          = document.getElementById("coctelesAcrilico");
  const crEl          = document.getElementById("coctelesCristaleria");

  const cantidadCatering   = document.getElementById("cantidadCatering");
  const platosDescripcion  = document.getElementById("platosDescripcion");
  const firmaCateringSelect= document.getElementById("firmaCateringSelect");

  // BLOQUES DE HORA
  const horaGeneralField = document.getElementById("horaGeneralField");
  const horaH = document.getElementById("horaH");
  const horaM = document.getElementById("horaM");
  const horaAP = document.getElementById("horaAP");

  const horaComBlock  = document.getElementById("horaComBlock");
  const horaCockBlock = document.getElementById("horaCockBlock");

  function setReq(el,on){ if(!el) return; on ? el.setAttribute("required","") : el.removeAttribute("required"); }

  function setReqHoraGeneral(on){
    [horaH, horaM, horaAP].forEach(el => {
      if (!el) return;
      if (on) el.setAttribute("required",""); else el.removeAttribute("required");
    });
  }

  function refreshCocteles(){
    const sep = coctelesModo.value === "separado";
    const t = tipoEl.value;
    const barmanOn = (t === "barman" || t === "ambos");
    sepWrap.classList.toggle("hidden", !sep);
    totalWrap.classList.toggle("hidden", sep);
    setReq(coctelesTipo, barmanOn && !sep);
    setReq(totalEl, barmanOn && !sep);
    setReq(acEl,     barmanOn &&  sep);
    setReq(crEl,     barmanOn &&  sep);

    // Si est√° en modo total y hay cantidad, forzar Acr√≠lico por defecto si no se eligi√≥ tipo
    if (barmanOn && !sep) {
      const n = parseFloat((document.getElementById("coctelesCantidadTotal").value)||0);
      if (!coctelesTipo.value && n>0) coctelesTipo.value = 'Acr√≠lico';
    }
  }

  function refreshTipo(){
    const t = tipoEl.value;
    const barmanOn   = (t === "barman" || t === "ambos");
    const cateringOn = (t === "catering" || t === "ambos");

    // Secciones barman / catering
    secBarman.classList.toggle("hidden", !barmanOn);
    secCatering.classList.toggle("hidden", !cateringOn);
    firmaBarman.classList.toggle("hidden", !barmanOn);
    firmaCatering.classList.toggle("hidden", !cateringOn);
    firmaAmbos.classList.toggle("hidden", t !== "ambos");

    setReq(cantidadCatering,  cateringOn);
    setReq(platosDescripcion, cateringOn);
    setReq(firmaCateringSelect, t === "catering");

    // HORAS: qu√© se ve seg√∫n tipo
    if (!t) {
      // Sin tipo seleccionado: mostrar solo hora general
      if (horaGeneralField) horaGeneralField.classList.remove("hidden");
      if (horaComBlock)  horaComBlock.classList.add("hidden");
      if (horaCockBlock) horaCockBlock.classList.add("hidden");
      setReqHoraGeneral(true);
    } else if (t === "barman") {
      // Solo barman -> solo hora cocteles
      if (horaGeneralField) horaGeneralField.classList.add("hidden");
      if (horaComBlock)  horaComBlock.classList.add("hidden");
      if (horaCockBlock) horaCockBlock.classList.remove("hidden");
      setReqHoraGeneral(false);
    } else if (t === "catering") {
      // Solo catering -> solo hora comida
      if (horaGeneralField) horaGeneralField.classList.add("hidden");
      if (horaComBlock)  horaComBlock.classList.remove("hidden");
      if (horaCockBlock) horaCockBlock.classList.add("hidden");
      setReqHoraGeneral(false);
    } else if (t === "ambos") {
      // Ambos -> solo horas espec√≠ficas (comida + cocteles)
      if (horaGeneralField) horaGeneralField.classList.add("hidden");
      if (horaComBlock)  horaComBlock.classList.remove("hidden");
      if (horaCockBlock) horaCockBlock.classList.remove("hidden");
      setReqHoraGeneral(false);
    }

    refreshCocteles();
 refreshHorasRequired();  // üëà esto al final de refreshTipo()
    // Proteger por si __precios a√∫n no est√° definido
    if (window.__precios && typeof window.__precios.calc === 'function') {
      window.__precios.calc();
    }
  }


    // Marca / desmarca required en las horas seg√∫n tipo y "hora por definir"
  function refreshHorasRequired() {
    const t = tipoEl.value;

    const hInd   = document.getElementById("horaIndefinida");
    const comInd = document.getElementById("horaComIndef");
    const cockInd= document.getElementById("horaCockIndef");

    // ¬øSe exige hora general?
    const needGeneral = (!t || t === "") && !(hInd && hInd.checked);

    // ¬øSe exige hora comida?
    const needCom = (t === "catering" || t === "ambos") && !(comInd && comInd.checked);

    // ¬øSe exige hora cocteles?
    const needCock = (t === "barman" || t === "ambos") && !(cockInd && cockInd.checked);

    // General
    setReq(horaH,  needGeneral);
    setReq(horaM,  needGeneral);
    setReq(horaAP, needGeneral);

    // Comida
    setReq(horaComH,  needCom);
    setReq(horaComM,  needCom);
    setReq(horaComAP, needCom);

    // Cocteles
    setReq(horaCockH,  needCock);
    setReq(horaCockM,  needCock);
    setReq(horaCockAP, needCock);
  }

    const hInd   = document.getElementById("horaIndefinida");
  const comInd = document.getElementById("horaComIndef");
  const cockInd= document.getElementById("horaCockIndef");

  [hInd, comInd, cockInd].forEach(el => {
    if (!el) return;
    el.addEventListener("change", refreshHorasRequired);
  });


  coctelesModo.addEventListener("change", () => { refreshCocteles(); window.__precios.calc(); });
  [coctelesTipo].forEach(el=> el.addEventListener('change', () => window.__precios.calc()));
  [document.getElementById('coctelesCantidadTotal'), document.getElementById('coctelesAcrilico'), document.getElementById('coctelesCristaleria')]
    .forEach(el => el.addEventListener('input', () => window.__precios.calc()));

  tipoEl.addEventListener("change", refreshTipo);

  // Llamar una vez al inicio
  refreshTipo();
})();


    // Movilidad: mostrar monto si est√° activo
    (function(){
      const movOn = document.getElementById('movOn');
      const movWrap = document.getElementById('movMontoWrap');
      const movIn = document.getElementById('movilidadMonto');
      function refresh(){
        movWrap.classList.toggle('hidden', !movOn.checked);
        if (movOn.checked) movIn.setAttribute('required',''); else movIn.removeAttribute('required');
      }
      movOn.addEventListener('change', refresh);
      refresh();
    })();

    // Ajuste para mostrar totales correctos seg√∫n tipo
(function autoPrecios(){
  const tipo = document.getElementById("tipo");
  const cantidad = document.getElementById("cantidadCatering");
  const precioPlato = document.getElementById("precioPlato");
  const total = document.getElementById("total");
  const adelanto = document.getElementById("adelanto");
  const resta = document.getElementById("resta");
  const detalleNote = document.getElementById('detalleTotalesNote');

  const wrapB = document.getElementById('wrapSubtotalBarman');
  const wrapC = document.getElementById('wrapSubtotalComida');
  const subB = document.getElementById('subtotalBarman');
  const subC = document.getElementById('subtotalComida');

  const coctelesModo = document.getElementById('coctelesModo');
  const coctelesTipo = document.getElementById('coctelesTipo');
  const cantTotal = document.getElementById('coctelesCantidadTotal');
  const cantAcr = document.getElementById('coctelesAcrilico');
  const cantCris = document.getElementById('coctelesCristaleria');

  function calcBarman(){
    const t = tipo.value;
    const barmanOn = (t === 'barman' || t === 'ambos');
    if (!barmanOn) return 0;
    const modo = coctelesModo.value;
    const P_ACR = 3.0, P_CRIS = 4.5;
    if (modo === 'separado'){
      const a = parseFloat(cantAcr.value||0);
      const c = parseFloat(cantCris.value||0);
      return (a*P_ACR) + (c*P_CRIS);
    } else {
      const n = parseFloat(cantTotal.value||0);
      const tipoV = coctelesTipo.value;
      if (tipoV === 'Acr√≠lico') return n * P_ACR;
      if (tipoV === 'Cristaler√≠a') return n * P_CRIS;
      return 0;
    }
  }

  function calcComida(){
    const t = tipo.value;
    const catOn = (t === 'catering' || t === 'ambos');
    if (!catOn) return 0;
    const cant = parseFloat(cantidad.value||0);
    const p = parseFloat(precioPlato.value||0);
    return (cant>0 && p>0)? cant*p : 0;
  }

  function calc(){
    const t = tipo.value;
    const barman = calcBarman();
    const comida = calcComida();
    let tot = 0;
    if (t === 'barman') tot = barman;
    else if (t === 'catering') tot = comida;
    else if (t === 'ambos') tot = barman + comida;

    // Mostrar/ocultar subtotales seg√∫n tipo
    if (t === 'ambos') {
      wrapB.classList.remove('hidden');
      wrapC.classList.remove('hidden');
    } else {
      wrapB.classList.add('hidden');
      wrapC.classList.add('hidden');
    }

    subB.value = barman.toFixed(2);
    subC.value = comida.toFixed(2);

    total.value = (tot||0).toFixed(2);
    const a = parseFloat(adelanto.value||0);
    resta.value = (tot - a).toFixed(2);

    // Nota inferior
    if (t === 'ambos') {
      detalleNote.textContent = `Detalle: Comida S/. ${comida.toFixed(2)} + Barman S/. ${barman.toFixed(2)} = Total S/. ${(tot).toFixed(2)}`;
    } else if (t === 'barman') {
      detalleNote.textContent = `Total Barman: S/. ${barman.toFixed(2)}`;
    } else if (t === 'catering') {
      detalleNote.textContent = `Total Catering: S/. ${comida.toFixed(2)}`;
    } else {
      detalleNote.textContent = '';
    }
  }

  [cantidad, precioPlato, adelanto].forEach(el => el.addEventListener("input", calc));
  [coctelesModo, coctelesTipo].forEach(el => el.addEventListener('change', calc));
  [cantTotal, cantAcr, cantCris].forEach(el => el.addEventListener('input', calc));
  tipo.addEventListener('change', calc);

  window.__precios = { calc, calcBarman, calcComida };
  calc();
})();


    // Fecha & Hora (helpers) + Hora por definir
    (function(){
      const fecha = document.getElementById('fecha');
      const hH = document.getElementById('horaH');
      const hM = document.getElementById('horaM');
      const hAP = document.getElementById('horaAP');
      const h24 = document.getElementById('hora');
      const preview = document.getElementById('previewFechaHora');
      const hInd = document.getElementById('horaIndefinida');
      if (!hH.value) hH.value = 7; if (!hM.value) hM.value = 0;
      function to24(h12, m, ap){ let h=parseInt(h12||0,10); let mm=String(parseInt(m||0,10)).padStart(2,'0'); ap=(ap||'AM').toUpperCase(); if(ap==='AM'){if(h===12)h=0}else{if(h!==12)h+=12} return `${String(h).padStart(2,'0')}:${mm}`; }
      function fFecha(iso){ if(!iso) return ""; const [Y,M,D]=iso.split('-').map(n=>parseInt(n,10)); return new Intl.DateTimeFormat('es-PE',{weekday:'long',year:'numeric',month:'long',day:'numeric'}).format(new Date(Y,(M-1),D)); }
      function fHora(hhmm){ if(!hhmm) return ""; const [H,M]=hhmm.split(':').map(n=>parseInt(n,10)); const d=new Date(); d.setHours(H||0,M||0,0,0); return new Intl.DateTimeFormat('es-PE',{hour:'numeric',minute:'2-digit',hour12:true}).format(d); }
      function sync(){
        if (hInd.checked){
          h24.value='';
          [hH,hM,hAP].forEach(el=>{ el.setAttribute('disabled',''); el.removeAttribute('required'); });
        } else {
          [hH,hM,hAP].forEach(el=>{ el.removeAttribute('disabled'); el.setAttribute('required',''); });
          h24.value=to24(hH.value,hM.value,hAP.value);
        }
        const ft=fFecha(fecha.value);
        const ht=hInd.checked? 'Hora por definir' : fHora(h24.value);
        preview.textContent=(ft)?`${ft} ‚Äî ${ht||''}`:'Selecciona fecha y hora‚Ä¶';
      }
      [fecha,hH,hM,hAP].forEach(el=>el.addEventListener('input',sync));
      hInd.addEventListener('change', sync);
      sync();
      window.__fechaHoraHelpers={horaTexto:()=> (hInd.checked? 'Hora por definir' : fHora(h24.value)), fechaTexto:()=>fFecha(fecha.value), horaIndefinida: ()=> !!hInd.checked };
    })();

    // Submit y funci√≥n global
    document.getElementById('contractForm').addEventListener('submit', function (e) {
      e.preventDefault();
      window.generarContrato();
    });

    // ================= generarContrato =================
    window.generarContrato = async function () {
      const form = document.getElementById("contractForm");

      // ===== Guardas de validaci√≥n antes de checkValidity() =====
      // === HORAS INDEPENDIENTES ===

      // Catering
      const horaComH  = document.getElementById("horaComH")?.value || "";
      const horaComM  = document.getElementById("horaComM")?.value || "";
      const horaComAP = document.getElementById("horaComAP")?.value || "PM";
      

      let horaCom24 = "";
      let horaComTexto = "";

      // ===== Horas espec√≠ficas (comida / cocteles) =====

      // --- Comida (catering) ---
      const horaComIndef = document.getElementById("horaComIndef")?.checked || false;
      let horaComida24 = "";
      let horaComidaTexto = "";

      if (!horaComIndef) {
        const hCH = document.getElementById("horaComH")?.value;
        const hCM = document.getElementById("horaComM")?.value;
        const hCAP = document.getElementById("horaComAP")?.value || "PM";

        if (hCH && hCM !== "") {
          let h = parseInt(hCH, 10) || 0;
          const mNum = parseInt(hCM, 10) || 0;
          const m = String(mNum).padStart(2, "0");

          let h24 = h % 12;
          if (hCAP === "PM") h24 += 12;

          horaComida24 = `${String(h24).padStart(2, "0")}:${m}`;

          const d = new Date();
          d.setHours(h24, mNum, 0, 0);
          horaComidaTexto = new Intl.DateTimeFormat("es-PE", {
            hour: "numeric",
            minute: "2-digit",
            hour12: true
          }).format(d);
        }
      }

      // --- Cocteles (barman) ---
      const horaCockIndef = document.getElementById("horaCockIndef")?.checked || false;
      let horaCoctel24 = "";
      let horaCoctelTexto = "";

      if (!horaCockIndef) {
        const hKH = document.getElementById("horaCockH")?.value;
        const hKM = document.getElementById("horaCockM")?.value;
        const hKAP = document.getElementById("horaCockAP")?.value || "PM";

        if (hKH && hKM !== "") {
          let h = parseInt(hKH, 10) || 0;
          const mNum = parseInt(hKM, 10) || 0;
          const m = String(mNum).padStart(2, "0");

          let h24 = h % 12;
          if (hKAP === "PM") h24 += 12;

          horaCoctel24 = `${String(h24).padStart(2, "0")}:${m}`;

          const d = new Date();
          d.setHours(h24, mNum, 0, 0);
          horaCoctelTexto = new Intl.DateTimeFormat("es-PE", {
            hour: "numeric",
            minute: "2-digit",
            hour12: true
          }).format(d);
        }
      }


      if (!horaComIndef && horaComH && horaComM) {
        const h = parseInt(horaComH, 10);
        const m = String(parseInt(horaComM, 10)).padStart(2, "0");
        let h24 = h % 12;
        if (horaComAP === "PM") h24 += 12;
        horaCom24 = `${String(h24).padStart(2, "0")}:${m}`;
        // Formato bonito
        const d = new Date();
        d.setHours(h24, m);
        horaComTexto = new Intl.DateTimeFormat("es-PE", {
          hour: "numeric",
          minute: "2-digit",
          hour12: true
        }).format(d);
      }

      // Cocteles
      const horaCockH  = document.getElementById("horaCockH")?.value || "";
      const horaCockM  = document.getElementById("horaCockM")?.value || "";
      const horaCockAP = document.getElementById("horaCockAP")?.value || "PM";
      

      let horaCock24 = "";
      let horaCockTexto = "";
      if (!horaCockIndef && horaCockH && horaCockM) {
        const h = parseInt(horaCockH, 10);
        const m = String(parseInt(horaCockM, 10)).padStart(2, "0");
        let h24 = h % 12;
        if (horaCockAP === "PM") h24 += 12;
        horaCock24 = `${String(h24).padStart(2, "0")}:${m}`;
        const d = new Date();
        d.setHours(h24, m);
        horaCockTexto = new Intl.DateTimeFormat("es-PE", {
          hour: "numeric",
          minute: "2-digit",
          hour12: true
        }).format(d);
      }

      // Barman en modo total: si hay cantidad y no se eligi√≥ tipo, asumir Acr√≠lico
      const tipoElTmp = document.getElementById('tipo');
      const coctelesModoTmp = document.getElementById('coctelesModo');
      const coctelesTipoTmp = document.getElementById('coctelesTipo');
      const cantTotalTmp = document.getElementById('coctelesCantidadTotal');
      const barmanOnTmp = (tipoElTmp.value === 'barman' || tipoElTmp.value === 'ambos');
      if (barmanOnTmp && coctelesModoTmp.value === 'total'){
        const nTmp = parseFloat(cantTotalTmp.value||0);
        if (nTmp>0 && !coctelesTipoTmp.value) coctelesTipoTmp.value = 'Acr√≠lico';
      }

      if (!form.checkValidity()) { alert("Por favor, completa todos los campos obligatorios."); return; }

      const tipo = document.getElementById("tipo").value;

      // Totales calculados (comida + barman)
      const subBarman = window.__precios.calcBarman();
      const subComida = window.__precios.calcComida();
      const totalCalc = (tipo === 'ambos') ? (subBarman + subComida) : (tipo==='barman'?subBarman:subComida);

      const total = parseFloat((totalCalc||0).toFixed(2));
      const adelanto = parseFloat(document.getElementById("adelanto").value);
      const resta = total - adelanto;

      // Movilidad
      const movOn = document.getElementById('movOn').checked;
      const movilidadMonto = movOn ? parseFloat(document.getElementById('movilidadMonto').value || '0') : 0;
      const movilidadTexto = movOn ? `S/. ${movilidadMonto.toFixed(2)}` : "No aplica";

      // Fechas/horas
      // ===== Fechas / hora general (tu c√≥digo de antes) =====
      const fecha = document.getElementById("fecha").value;
      const hora  = document.getElementById("hora").value; // puede ser vac√≠o si es indefinida
      const horaIndefinida = window.__fechaHoraHelpers.horaIndefinida();
      const horaTexto  = window.__fechaHoraHelpers.horaTexto();
      const fechaTexto = window.__fechaHoraHelpers.fechaTexto();

      


      const direccion = document.getElementById("direccion").value;
      const referencia = document.getElementById("referencia").value;
      const contratante = document.getElementById("contratante").value;
      const dni = document.getElementById("dni").value;
      const firmaCateringSelect = document.getElementById("firmaCateringSelect")?.value || "Rosario";
      const extras = document.getElementById('extras').value || '';

      // Barman
      const barmanChecks = [...document.querySelectorAll(".barmanCheck:checked")].map(x => x.value);
      const varCoctel = [
  ...document.querySelectorAll("input[name='cocteles']:checked")
].map(el => el.value.trim())
 .filter(Boolean);

const varCoctelUniq = [...new Set(varCoctel)];
      const coctelesTipo = document.getElementById("coctelesTipo")?.value || "";
      const coctelesModo = document.getElementById("coctelesModo")?.value || "total";
      const coctelesCantidadTotal = parseInt(document.getElementById("coctelesCantidadTotal")?.value || "0", 10);
      const coctelesAcrilico = parseInt(document.getElementById("coctelesAcrilico")?.value || "0", 10);
      const coctelesCristaleria = parseInt(document.getElementById("coctelesCristaleria")?.value || "0", 10);



      // Catering
      const cateringChecks = [...document.querySelectorAll(".cateringCheck:checked")].map(x => x.value);
      const selPlatos = document.getElementById("colorPlatos");
      const selServ = document.getElementById("colorServilletas");
      const colorPlatos = selPlatos?.value === 'otro' ? (document.getElementById('colorPlatosOtro').value||'') : (selPlatos?.value || "");
      const colorServilletas = selServ?.value === 'otro' ? (document.getElementById('colorServilletasOtro').value||'') : (selServ?.value || "");
      const cantidadCatering = document.getElementById("cantidadCatering")?.value || "";
      const platosDescripcion = document.getElementById("platosDescripcion")?.value || "";
      const cantidadMesas = document.getElementById("cantidadMesas")?.value || "";
      const cantidadMozos = document.getElementById("cantidadMozos")?.value || "";
      const chkPlatos = document.getElementById('chkPlatosSitio').checked;
      const chkServ = document.getElementById('chkServilletas').checked;
      const chkMozos = document.getElementById('chkMozos').checked;

      // Servicios (sin duplicados)
      const servicios = [];
      if (tipo === "barman" || tipo === "ambos") {
        servicios.push(...barmanChecks);
        let coctelTxt = "";
        if (coctelesModo === "total") {
          const precioUnit = (coctelesTipo === 'Cristaler√≠a') ? 4.5 : 3.0;
          coctelTxt = `Cocteles (${coctelesTipo}) ‚Äî Cant.: ${coctelesCantidadTotal} ‚Äî Precio unit.: S/. ${precioUnit.toFixed(2)}${varCoctel.length ? " ‚Äî Variedades: " + varCoctel.join(", ") : ""}`;
        } else {
          coctelTxt = `Cocteles ‚Äî Acr√≠lico: ${coctelesAcrilico} (S/. 3.00) | Cristaler√≠a: ${coctelesCristaleria} (S/. 4.50)${varCoctel.length ? " ‚Äî Variedades: " + varCoctel.join(", ") : ""}`;
        }
        servicios.push(coctelTxt);
      }
      if (tipo === "catering" || tipo === "ambos") {
        if (chkPlatos) servicios.push(`Platos de sitio${colorPlatos ? ` (${colorPlatos})` : ""}`);
        if (chkServ)   servicios.push(`Servilletas${colorServilletas ? ` (${colorServilletas})` : ""}`);

        // Otros √≠tems de Catering (sin duplicar Platos de sitio, Servilletas ni Mozos)
        cateringChecks.forEach(v => {
          if (v === "Platos de sitio" || v === "Servilletas" || v === "Mozos") return;
          servicios.push(v); // Copas, Cubiertos dorados, etc.
        });

        // Mesas (si aplica)
        if ((chkPlatos || chkServ) && cantidadMesas) {
          servicios.push(`Mesas: ${cantidadMesas}`);
        }

        // Mozos (si aplica)
        if (chkMozos && cantidadMozos) {
          servicios.push(`Mozos: ${cantidadMozos}`);
        }

        // Datos de comida
        if (cantidadCatering) servicios.push(`Cantidad de platos: ${cantidadCatering}`);
        if (platosDescripcion) servicios.push(`Comida: ${platosDescripcion}`);
      }

      // Extras (si hay)
      if (extras.trim()) servicios.push(`Extras: ${extras.trim()}`);

      // Rubros / detalle de precios
      let rubrosBase = (tipo === "barman") ? "Cocteles" : (tipo === "catering") ? "Comida" : "Comida y Cocteles";
      let detallePrecio = '';
      let rubrosTexto = '';
      if (tipo === 'ambos'){
        rubrosTexto = `Comida S/. ${subComida.toFixed(2)} + Cocteles S/. ${subBarman.toFixed(2)} ‚Äî Total S/. ${(subComida+subBarman).toFixed(2)}`;
        detallePrecio = `Comida S/. ${subComida.toFixed(2)} | Barman S/. ${subBarman.toFixed(2)}`;
      } else if (tipo === 'barman'){
        rubrosTexto = `Cocteles ‚Äî Total S/. ${subBarman.toFixed(2)}`;
        detallePrecio = `Cocteles S/. ${subBarman.toFixed(2)}`;
      } else {
        rubrosTexto = `Comida ‚Äî Total S/. ${subComida.toFixed(2)}`;
        detallePrecio = `Comida S/. ${subComida.toFixed(2)}`;
      }

      // Archivo
      const ahora = new Date();
      const fechaNom = ahora.toISOString().slice(0, 10);
      const horaNom = ahora.toTimeString().slice(0, 5).replace(":", "-");
      const nombreArchivo = `Contrato_${tipo}_${fechaNom}_${horaNom}.pdf`;

      // Payload
      const payload = {
        tipo,
        adelanto,
        total,
        resta,

        // Movilidad
        movOn,
        movilidadMonto,
        movilidadTexto,

        rubrosTexto,
        detallePrecio,

        // Cliente
        cliente: contratante,
        dniCliente: dni,

        // Fecha general
        fecha,
        fechaTexto,
        horaIndefinida,

        // Hora general (fallback original)
        hora,
        horaTexto,

        // Horas espec√≠ficas
        horaComida24,
        horaComidaTexto,
        horaComidaIndefinida: horaComIndef,

        horaCoctel24,
        horaCoctelTexto,
        horaCoctelIndefinida: horaCockIndef,

        // Ubicaci√≥n
        direccion,
        referencia,

        // Servicios
        servicios,
        extras,
        firmaCatering: firmaCateringSelect,

        // Archivo
        filename: nombreArchivo,

        // Catering
        cantidadCatering,
        platosDescripcion,
        precioPlato: parseFloat(document.getElementById("precioPlato").value || "0"),

        // Totales
        totales: {
          barman: subBarman,
          comida: subComida,
          total: (subBarman + subComida)
        },
        totalCocteles: subBarman,
        totalComida: subComida,

        // Cocteles
        cocteles: {
          modo: coctelesModo,
          total: coctelesCantidadTotal,
          acrilico: coctelesAcrilico,
          cristaleria: coctelesCristaleria,
          tipoVajilla: coctelesTipo,
          precios: { acrilico: 3.0, cristaleria: 4.5 },
          variedades: varCoctelUniq
        },

        // Edici√≥n
        editingId: __editingId,
        prevPdfPath: __oldPdfPath
      };



      // Empaquetar mensaje y pasarlo por URL con Base64 UTF-8
      const msg = { type: "fill-contract", autoDownload: true, payload };
      const json = JSON.stringify(msg);
      const utf8 = new TextEncoder().encode(json);
      const b64  = btoa(String.fromCharCode(...utf8));
      const q = encodeURIComponent(b64);
      window.location.href = `./contratoTemplate.html?m=${q}`;
    };

    // ================= EDICI√ìN DE CONTRATOS EXISTENTES =================
let __editingId = null;
let __oldPdfPath = null; // ruta del PDF actual en Supabase

async function loadContratoExistente(id) {
  try {
    const { data, error } = await supabase
      .from("contratos")
      .select("*")
      .eq("id", id)
      .maybeSingle();

    if (error) {
      console.error("Error cargando contrato para edici√≥n:", error);
      alert("No se pudo cargar el contrato para editar.");
      return;
    }
    if (!data) {
      alert("Contrato no encontrado.");
      return;
    }

    __editingId = id;
    __oldPdfPath = data.pdf_path || null;
    const c = data.payload || {};

    // === Tipo ===
    const tipoEl = document.getElementById("tipo");
    if (tipoEl) {
      tipoEl.value = c.tipo || "";
      tipoEl.dispatchEvent(new Event("change"));
    }

    // === Datos del cliente ===
    document.getElementById("contratante").value = c.cliente || "";
    document.getElementById("dni").value = c.dniCliente || "";

    // === Direcci√≥n / referencia ===
    document.getElementById("direccion").value = c.direccion || "";
    document.getElementById("referencia").value = c.referencia || "";

    // === Extras ===
    document.getElementById("extras").value = c.extras || "";

    // === Totales ===
    if (typeof data.total !== "undefined") {
      document.getElementById("total").value = Number(data.total || 0).toFixed(2);
    }
    if (typeof data.adelanto !== "undefined") {
      document.getElementById("adelanto").value = Number(data.adelanto || 0).toFixed(2);
    }
    if (typeof data.resta !== "undefined") {
      document.getElementById("resta").value = Number(data.resta || 0).toFixed(2);
    }

    // === Movilidad ===
    if (c.movOn) {
      const movOn = document.getElementById("movOn");
      const movMonto = document.getElementById("movilidadMonto");
      movOn.checked = true;
      movOn.dispatchEvent(new Event("change"));
      if (movMonto) movMonto.value = c.movilidadMonto || "";
    }

    // === Fecha ===
    if (c.fecha) {
      const fecha = document.getElementById("fecha");
      if (fecha) fecha.value = c.fecha;
    }

    // === Hora GENERAL (legacy) ===
    const hInd = document.getElementById("horaIndefinida");
    const hH = document.getElementById("horaH");
    const hM = document.getElementById("horaM");
    const hAP = document.getElementById("horaAP");

    if (c.horaIndefinida) {
      if (hInd) hInd.checked = true;
    } else if (c.hora) {
      const [HH, MM] = c.hora.split(":").map(Number);
      let ap = "AM";
      let h12 = HH;

      if (HH === 0) {
        h12 = 12;
        ap = "AM";
      } else if (HH === 12) {
        h12 = 12;
        ap = "PM";
      } else if (HH > 12) {
        h12 = HH - 12;
        ap = "PM";
      }

      if (hH) hH.value = h12;
      if (hM) hM.value = MM;
      if (hAP) hAP.value = ap;
    }

    ["fecha", "horaH", "horaM", "horaAP"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.dispatchEvent(new Event("input"));
    });
    if (hInd) hInd.dispatchEvent(new Event("change"));


    // ================================
    // === HORAS ESPEC√çFICAS NUEVAS ===
    // ================================

    // --- Hora COMIDA ---
    const horaComIndefChk = document.getElementById("horaComIndef");
    const horaComH = document.getElementById("horaComH");
    const horaComM = document.getElementById("horaComM");
    const horaComAP = document.getElementById("horaComAP");

    if (horaComIndefChk) {
      if (c.horaComidaIndefinida) {
        horaComIndefChk.checked = true;
      } else {
        horaComIndefChk.checked = false;

        if (c.horaComida24) {
          const [hc24, mc] = c.horaComida24.split(":").map(Number);

          let h12 = hc24 % 12;
          if (h12 === 0) h12 = 12;
          const ap = hc24 >= 12 ? "PM" : "AM";

          if (horaComH) horaComH.value = h12;
          if (horaComM) horaComM.value = mc;
          if (horaComAP) horaComAP.value = ap;
        }
      }
      // forzar refresco si tienes listeners
      horaComIndefChk.dispatchEvent(new Event("change"));
    }

    // --- Hora COCTELES ---
    const horaCockIndefChk = document.getElementById("horaCockIndef");
    const horaCockH = document.getElementById("horaCockH");
    const horaCockM = document.getElementById("horaCockM");
    const horaCockAP = document.getElementById("horaCockAP");

    if (horaCockIndefChk) {
      if (c.horaCoctelIndefinida) {
        horaCockIndefChk.checked = true;
      } else {
        horaCockIndefChk.checked = false;

        if (c.horaCoctel24) {
          const [hk24, mk] = c.horaCoctel24.split(":").map(Number);

          let h12 = hk24 % 12;
          if (h12 === 0) h12 = 12;
          const ap = hk24 >= 12 ? "PM" : "AM";

          if (horaCockH) horaCockH.value = h12;
          if (horaCockM) horaCockM.value = mk;
          if (horaCockAP) horaCockAP.value = ap;
        }
      }
      horaCockIndefChk.dispatchEvent(new Event("change"));
    }

    // === Catering: cantidad, comida, precio ===
    if (document.getElementById("cantidadCatering")) {
      document.getElementById("cantidadCatering").value = c.cantidadCatering || "";
    }
    if (document.getElementById("platosDescripcion")) {
      document.getElementById("platosDescripcion").value = c.platosDescripcion || "";
    }
    if (typeof c.precioPlato !== "undefined" && document.getElementById("precioPlato")) {
      document.getElementById("precioPlato").value = c.precioPlato;
    }

    // === Barman: cocteles ===
    const co = c.cocteles || {};
    const coModo = document.getElementById("coctelesModo");
    const coTipo = document.getElementById("coctelesTipo");
    const coCantTotal = document.getElementById("coctelesCantidadTotal");
    const coAcr = document.getElementById("coctelesAcrilico");
    const coCris = document.getElementById("coctelesCristaleria");

    if (coModo) {
      coModo.value = co.modo || "total";
      coModo.dispatchEvent(new Event("change"));
    }

    if (co.modo === "total") {
      if (coCantTotal) coCantTotal.value = co.total || "";
      if (coTipo && co.tipoVajilla) coTipo.value = co.tipoVajilla;
    } else if (co.modo === "separado") {
      if (coAcr) coAcr.value = co.acrilico || "";
      if (coCris) coCris.value = co.cristaleria || "";
    }

    // Variedades de cocteles
    if (Array.isArray(co.variedades)) {
      co.variedades.forEach(nombre => {
        const chk = document.querySelector(`input[name="cocteles"][value="${nombre}"]`);
        if (chk) chk.checked = true;
      });
    }

    // === Servicios (para checkboxes de catering/barman) ===
    const servicios = Array.isArray(c.servicios) ? c.servicios : [];

    // Barman: Barman / Ayudante / Barra m√≥vil
    if (servicios.length) {
      servicios.forEach(s => {
        if (s === "Barman") {
          const cb = document.querySelector('.barmanCheck[value="Barman"]');
          if (cb) cb.checked = true;
        }
        if (s === "Ayudante de barra") {
          const cb = document.querySelector('.barmanCheck[value="Ayudante de barra"]');
          if (cb) cb.checked = true;
        }
        if (s === "Barra m√≥vil") {
          const cb = document.querySelector('.barmanCheck[value="Barra m√≥vil"]');
          if (cb) cb.checked = true;
        }
      });
    }

    // Catering: Platos de sitio
    const chkPlatos = document.getElementById("chkPlatosSitio");
    const platosItem = servicios.find(s => /^Platos de sitio/i.test(s));
    if (chkPlatos && platosItem) {
      chkPlatos.checked = true;
      chkPlatos.dispatchEvent(new Event("change"));

      const mColor = platosItem.match(/\(([^)]+)\)/);
      if (mColor) {
        const colorPlatos = document.getElementById("colorPlatos");
        const otroPlatos = document.getElementById("colorPlatosOtro");
        if (colorPlatos) {
          const opt = [...colorPlatos.options].find(o => o.value === mColor[1]);
          if (opt) {
            colorPlatos.value = mColor[1];
          } else {
            colorPlatos.value = "otro";
            if (otroPlatos) otroPlatos.value = mColor[1];
          }
          colorPlatos.dispatchEvent(new Event("change"));
        }
      }
    }

    // Catering: Servilletas
    const chkServ = document.getElementById("chkServilletas");
    const servItem = servicios.find(s => /^Servilletas/i.test(s));
    if (chkServ && servItem) {
      chkServ.checked = true;
      chkServ.dispatchEvent(new Event("change"));

      const mColor = servItem.match(/\(([^)]+)\)/);
      if (mColor) {
        const colorServ = document.getElementById("colorServilletas");
        const otroServ = document.getElementById("colorServilletasOtro");
        if (colorServ) {
          const opt = [...colorServ.options].find(o => o.value === mColor[1]);
          if (opt) {
            colorServ.value = mColor[1];
          } else {
            colorServ.value = "otro";
            if (otroServ) otroServ.value = mColor[1];
          }
          colorServ.dispatchEvent(new Event("change"));
        }
      }
    }

    // Copas
    const chkCopas = document.getElementById("chkCopas");
    if (chkCopas && servicios.some(s => /^Copas$/i.test(s.trim()))) {
      chkCopas.checked = true;
    }

    // Cubiertos dorados
    const chkCubiertos = document.getElementById("chkCubiertos");
    if (chkCubiertos && servicios.some(s => /^Cubiertos dorados$/i.test(s.trim()))) {
      chkCubiertos.checked = true;
    }

    // Mesas
    const mesasItem = servicios.find(s => /^Mesas:\s*\d+/i.test(s));
    if (mesasItem) {
      const m = mesasItem.match(/Mesas:\s*(\d+)/i);
      if (m) {
        const cantidadMesas = document.getElementById("cantidadMesas");
        const mesasWrap = document.getElementById("mesasWrap");
        if (cantidadMesas) cantidadMesas.value = m[1];
        if (mesasWrap) mesasWrap.classList.remove("hidden");
      }
    }

    // Mozos
    const mozosItem = servicios.find(s => /^Mozos:\s*\d+/i.test(s));
    if (mozosItem) {
      const m = mozosItem.match(/Mozos:\s*(\d+)/i);
      const chkMozos = document.getElementById("chkMozos");
      const cantMozos = document.getElementById("cantidadMozos");
      if (chkMozos) {
        chkMozos.checked = true;
        chkMozos.dispatchEvent(new Event("change"));
      }
      if (cantMozos && m) cantMozos.value = m[1];
    }

    // Firmas catering
    if (c.firmaCatering) {
      const firmaSel = document.getElementById("firmaCateringSelect");
      if (firmaSel) firmaSel.value = c.firmaCatering;
    }

    // Recalcular totales
    if (window.__precios && typeof window.__precios.calc === "function") {
      window.__precios.calc();
    }

    // Cambiar texto del bot√≥n
    const btnSubmit = document.querySelector("#contractForm button[type='submit']");
    if (btnSubmit) {
      btnSubmit.textContent = "üìÑ Guardar cambios (crea nuevo contrato)";
    }

  } catch (e) {
    console.error("Error inesperado cargando contrato:", e);
    alert("Ocurri√≥ un error al cargar el contrato.");
  }
}

// Al cargar la p√°gina, si viene ?contratoId=..., rellenar el formulario
window.addEventListener("load", () => {
  const params = new URLSearchParams(location.search);
  const id = params.get("contratoId");
  if (id) {
    loadContratoExistente(id);
  }
});

  </script>
</body>
</html>
