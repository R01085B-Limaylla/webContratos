<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Contrato ‚Äî La Marquesina</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="./style.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="contratoTemplate.css">
  <link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="contratoTemplato.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="./script.js"></script>
  <script defer src="./popups-loader.js"></script>

 
 </head>
<body>

  <div id="popups-root"></div>

<div class="pdf-toolbar no-print">
  <!-- Fila superior: Editar / Ver contratos -->
  <div class="pdf-row pdf-row-secondary">
    <button class="pdf-btn pdf-secondary" onclick="editarContratoDesdeTemplate()">
      ‚úèÔ∏è Editar este contrato
    </button>
    <button class="pdf-btn pdf-secondary" onclick="window.location.href='ver.html'">
      üìã Ver contratos
    </button>
  </div>

  <!-- Fila inferior: Abrir / Compartir / Imprimir -->
  <div class="pdf-row pdf-row-main">
    <button class="pdf-btn pdf-main" id="__btnpdf" onclick="AndroidBridge.openPdfExternally()">
      üìÑ Abrir PDF
    </button>
    <button class="pdf-btn pdf-main" id="__btnshare" onclick="AndroidBridge.sharePdf()">
      üì§ Compartir
    </button>
    <button class="pdf-btn pdf-main" id="__btnprint" onclick="AndroidBridge.printSystem()">
      üñ®Ô∏è Imprimir
    </button>
  </div>
</div>

<div id="contrato" class="page">
  <div class="content">
    <h2 id="titulo"></h2>

    <p id="textoPrincipal"></p>

    <h3>Servicios:</h3>
    <ul id="listaServicios"></ul>

    <h3>Condiciones Econ√≥micas:</h3>
    <ul>
      <li><b id="rubrosLabel">Concepto:</b> <span id="rubros"></span></li>
      <li><b>Adelanto:</b> S/. <span id="adelanto"></span></li>
      <li><b>Resta:</b> S/. <span id="resta"></span></li>
      <li><b>Movilidad:</b> <span id="movilidad"></span></li>
    </ul>

    <div id="detalleEvento"></div>

    <!-- === BLOQUE FINAL (siempre al pie) === -->
    <div id="bloqueFinal">
      <div id="fechaActual"></div>
      <p id="clausula">
        CL√ÅUSULA: SI EL CONTRATANTE DESISTE DE FORMALIZAR EL CONTRATO, NO SE REALIZAR√Å
        EL REEMBOLSO DEL ADELANTO CONSIDERADO COMO SEPARACI√ìN DE FECHA.
      </p>

      <div class="firmas">
        <div id="firmaRosario" class="firma">
          <img src="img/firma-rosario.png" alt="Rosario">
          <div>Rosario Carhuallanqui <br> DNI: 20026242</div>
        </div>
        <div id="firmaSebastian" class="firma">
          <img src="img/firma-sebastian.png" alt="Sebasti√°n">
          <div>Sebasti√°n Limaylla <br> DNI: 76440595</div>
        </div>
        <div id="firmaSujey" class="firma hidden">
          <img src="img/firma-sujey.png" alt="Sujey">
          <div>Sujey Solorzano <br> DNI: 74874635</div>
        </div>
        <div id="firmaContratante" class="firma hidden">
          <div class="linea"></div>
          <div><span id="nombreContratante"></span><br>DNI: <span id="dniContratante"></span></div>
        </div>
      </div>

    </div>
  </div>
</div>

  <script>
   
         // Lee ?m=..., decodifica UTF-8, guarda el mensaje y lo despacha cuando la p√°gina est√© lista
(function () {
  try {
    const mParam = new URLSearchParams(location.search).get("m");
    if (!mParam) return;

    // Decodificaci√≥n Base64 UTF-8
    const b64   = decodeURIComponent(mParam);
    const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    const json  = new TextDecoder().decode(bytes);
    const msg   = JSON.parse(json);

    // Gu√°rdalo globalmente por si hace falta leerlo luego
    window.__BOOT_MSG = msg;

    // Despacha el evento 'message' cuando la p√°gina ya registr√≥ sus listeners
    const dispatch = () => {
      try {
        const ev = new MessageEvent("message", { data: msg, origin: location.origin, source: window });
        window.dispatchEvent(ev);
      } catch (e) { console.error(e); }
    };

    // Si el DOM ya est√° listo, dispara al pr√≥ximo tick; si no, espera 'load'
    if (document.readyState === "complete" || document.readyState === "interactive") {
      setTimeout(dispatch, 0);
    } else {
      window.addEventListener("load", () => setTimeout(dispatch, 0), { once: true });
    }

    // (Opcional) limpiar la URL
    // history.replaceState(null, "", location.pathname);
  } catch (e) {
    console.error("Error leyendo datos del contrato:", e);
  }
})();
    
    // ---------- Handshake ----------
    window.addEventListener("load", () => {
      try { if (window.opener) window.opener.postMessage({ type: "template-ready" }, "*"); } catch {}
    });
    window.addEventListener("message", (e) => {
      if (e?.data?.type === "ping") {
        try { if (window.opener) window.opener.postMessage({ type: "template-ack" }, "*"); } catch {}
      }
    });

    // ---------- Utilidades ----------
    function n2(n){ return Number(n||0).toFixed(2); }
    function buscarCantidadPlatos(contrato){
        if (contrato.cantidadCatering && Number(contrato.cantidadCatering) > 0) {
            return Number(contrato.cantidadCatering);
        }
        const hit = (contrato.servicios || []).find(s => /cantidad(?:\s+de\s+platos)?\s*:\s*\d+/i.test(s));
        if (hit) {
            const m = hit.match(/cantidad(?:\s+de\s+platos)?\s*:\s*(\d+)/i);
            if (m) return Number(m[1]);
        }
        return null;
        }

 // Helper robusto: Cocteles con precios + variedades (lee de payload y, si falta, de servicios)
function buildCoctelLinea(c) {
  if (!c) return "";

  // 1) Intentar desde payload.cocteles
  let a = 0, r = 0; // acr√≠lico, cristaler√≠a
  const modo = c.cocteles?.modo;
  const tipo = (c.cocteles?.tipoVajilla || "").trim();

  if (modo === "separado") {
    a = Number(c.cocteles?.acrilico || 0);
    r = Number(c.cocteles?.cristaleria || 0);
  } else if (modo === "total" && Number(c.cocteles?.total) > 0) {
    if (/^acr√≠lico$/i.test(tipo)) a = Number(c.cocteles.total);
    else if (/^cristaler√≠a$/i.test(tipo)) r = Number(c.cocteles.total);
  }

  // 2) Si a√∫n no hay datos, intentar deducir desde servicios (texto)
  if (!a && !r && Array.isArray(c.servicios)) {
    const joined = c.servicios.join(" | ");
    const mA = joined.match(/Acr[i√≠]lico(?:\s*[:=]|\s+)(\d+)/i);
    const mR = joined.match(/Cristaler[i√≠]a(?:\s*[:=]|\s+)(\d+)/i);
    if (mA) a = Number(mA[1]);
    if (mR) r = Number(mR[1]);

    // Caso: "(Cristaler√≠a) ‚Äî Cant.: 80" o "(Acr√≠lico) ‚Äî Cant.: 50"
    if (!a && !r) {
      const mTotCris = joined.match(/\(Cristaler[i√≠]a\)[^\d]*Cant\.\s*:\s*(\d+)/i);
      const mTotAcr  = joined.match(/\(Acr[i√≠]lico\)[^\d]*Cant\.\s*:\s*(\d+)/i);
      if (mTotCris) r = Number(mTotCris[1]);
      if (mTotAcr)  a = Number(mTotAcr[1]);
    }
  }

  // Si no hay cantidades, no mostramos
  if (!a && !r) return "";

  // Variedades: primero payload, luego fallback a servicios
  let variedades = "";
  if (Array.isArray(c.cocteles?.variedades) && c.cocteles.variedades.length) {
    variedades = c.cocteles.variedades.join(", ");
  } else if (Array.isArray(c.servicios)) {
    const hit = c.servicios.find(s => /Variedades\s*:/i.test(s));
    const tail = hit?.match(/Variedades\s*:\s*(.+)$/i)?.[1]?.trim();
    if (tail) variedades = tail;
  }

  const partes = [];
  if (a) partes.push(`Acr√≠lico ${a} (S/.3.00 c/u)`);
  if (r) partes.push(`Cristaler√≠a ${r} (S/.4.50 c/u)`);

  let linea = `Cocteles: ${partes.join(" - ")}`;
  if (variedades) linea += ` - ${variedades}`;
  return linea;
}


    // === CANDADO para evitar m√∫ltiples descargas ===
    let __alreadyProcessed = false;
    
    // ===== Helpers de formato (fecha/hora bonitas) =====
    function formatearFechaISO(iso) {
      if (!iso) return "";
      const [Y, M, D] = iso.split("-").map(n => parseInt(n, 10));
      const d = new Date(Y, M - 1, D);
      return new Intl.DateTimeFormat("es-PE", {
        weekday: "long", day: "numeric", month: "long", year: "numeric"
      }).format(d);
    }

    function formatearHora24(hhmm) {
      if (!hhmm) return "";
      const [H, m] = hhmm.split(":").map(n => parseInt(n, 10));
      const d = new Date(); d.setHours(H || 0, m || 0, 0, 0);
      return new Intl.DateTimeFormat("es-PE", {
        hour: "numeric", minute: "2-digit", hour12: true
      }).format(d);
    }

function mayusInicial(txt) {
  return txt ? txt.charAt(0).toUpperCase() + txt.slice(1) : "";
}

    
    // ---------- Relleno y descarga ----------
            window.addEventListener("message", async (e) => {
          const data = e?.data;
          if (data?.type !== "fill-contract") return;

          if (__alreadyProcessed) return;
          __alreadyProcessed = true;

          const c = data.payload;
          if (!c) return;

           // Mostrar popup cargando
            openLoadingPopup();

          // ==== HORAS ESPEC√çFICAS PARA EL CONTRATO ====

          let textoComida = "";
          let textoCoctel = "";

          if (c.tipo === "catering" || c.tipo === "ambos") {
            if (c.horaComidaIndefinida) {
              textoComida = "los platos de comida se servir√°n en horario por definir";
            } else if (c.horaComidaTexto) {
              textoComida = `los platos de comida se servir√°n a las ${c.horaComidaTexto}`;
            }
          }

          if (c.tipo === "barman" || c.tipo === "ambos") {
            if (c.horaCoctelIndefinida) {
              textoCoctel = "los cocteles se preparar√°n en horario por definir";
            } else if (c.horaCoctelTexto) {
              textoCoctel = `los cocteles se preparar√°n a las ${c.horaCoctelTexto}`;
            }
          }

          let textoHoras = "";
          if (textoComida && textoCoctel) {
            textoHoras = `${textoComida} y ${textoCoctel}`;
          } else {
            textoHoras = textoComida || textoCoctel;
          }

          if (!textoHoras) {
            const horaBonita = c.horaTexto || "";
            if (c.tipo === "barman") {
              textoHoras = `los cocteles se preparar√°n a las ${horaBonita}`;
            } else if (c.tipo === "catering") {
              textoHoras = `los platos de comida se servir√°n a las ${horaBonita}`;
            } else {
              textoHoras = `los cocteles y platos de comida se preparar√°n a las ${horaBonita}`;
            }
          }


      // T√≠tulo
      document.getElementById("titulo").innerHTML =
  `<br> CONTRATO DE SERVICIO DE ${String(c.tipo || "").toUpperCase()}`;

  const elementoTitulo = document.getElementById("titulo");
elementoTitulo.style.textAlign = "center";
elementoTitulo.style.fontSize = "11pt"; // O "11px", "11rem", etc.


      // Intro seg√∫n tipo
      let introHTML = "";
      if (c.tipo === "catering") {
        const cantidadPlatos = buscarCantidadPlatos(c);
        const cantidadTxt = (cantidadPlatos !== null) ? `${cantidadPlatos}` : "los";
        const descComida = (c.platosDescripcion || "").trim();
        const descParte  = descComida ? ` (${descComida})` : "";
         introHTML = `
          Yo, <b>Sujey Solorzano Vicharra</b> y <b>Rosario Carhuallanqui Ruiz</b>,
          socios de <b>LA MARQUESINA CATERING</b> con RUC 20611125918,
          recibo la suma de <b>S/. ${n2(c.adelanto)}</b> de
          <b>${c.cliente}</b> identificado(a) con DNI <b>${c.dniCliente}</b>,
          para la prestaci√≥n de servicios para la <b>preparaci√≥n de ${cantidadTxt} platos de comida ${descParte} </b>.
        `;
      } else if (c.tipo === "barman") {
        introHTML = `
          Yo, <b>ROSARIO CARHUALLANQUI RUIZ</b>, en representaci√≥n de
          <b>LA MARQUESINA CATERING</b> con RUC 20611125918, recibo la suma de
          <b>S/. ${n2(c.adelanto)}</b> para la prestaci√≥n de servicios de Cocteles </b>,
          a cargo del Barman <b>SEBASTI√ÅN LIMAYLLA CARHUALLANQUI</b> identificado con DNI 76440595,
          de <b>${c.cliente}</b> identificado con DNI <b>${c.dniCliente}</b>.
        `;
      } else {
        introHTML = `
          Yo, <b>ROSARIO CARHUALLANQUI RUIZ</b>, en representaci√≥n de
          <b>LA MARQUESINA CATERING</b> con RUC 20611125918, recibo la suma de
          <b>S/. ${n2(c.adelanto)}</b> de <b>${c.cliente}</b> identificado con DNI <b>${c.dniCliente}</b>
          para la prestaci√≥n de servicios de <b>Catering y Barman</b>.
        `;
      }
      document.getElementById("textoPrincipal").innerHTML = introHTML;




// ===============================
// üßæ LISTA DE SERVICIOS (formato final con precios de cocteles)
// ===============================
const ul = document.getElementById("listaServicios");
ul.innerHTML = "";

const precioPlato = Number(c.precioPlato || 0);

// Helper
function addLine(texto) {
  if (!texto) return;
  const li = document.createElement("li");
  li.textContent = texto;
  ul.appendChild(li);
}


// ===================================================
// TIPO: AMBOS
// ===================================================
if (c.tipo === "ambos") {
  const platosItem = (c.servicios || []).find(s => /^Platos de sitio/i.test(s));
  const servItem   = (c.servicios || []).find(s => /^Servilletas/i.test(s));
  const mesasItem  = (c.servicios || []).find(s => /^Mesas:\s*\d+/i.test(s));

  const platosColor = platosItem?.match(/\(([^)]+)\)/)?.[1] || null;
  const servColor   = servItem?.match(/\(([^)]+)\)/)?.[1] || null;
  const mesasNum    = mesasItem?.match(/Mesas:\s*(\d+)/i)?.[1] || null;

  const l1Parts = [];
  if (platosItem) l1Parts.push(`Platos de sitio${platosColor ? `(${platosColor})` : ""}`);
  if (servItem)   l1Parts.push(`Servilletas${servColor ? `(${servColor})` : ""}`);
  if (mesasNum)   l1Parts.push(`Mesas: ${mesasNum}`);
  if (l1Parts.length) addLine(l1Parts.join(" - "));

  const l2Parts = [];
  if ((c.servicios || []).some(s => /^Copas$/i.test(s))) l2Parts.push("Copas");
  if ((c.servicios || []).some(s => /^Cubiertos dorados$/i.test(s))) l2Parts.push("Cubiertos dorados");
  if (l2Parts.length) addLine(l2Parts.join(" - "));

  const mozosItem = (c.servicios || []).find(s => /^Mozos:\s*\d+/i.test(s));
  const mozosNum = mozosItem?.match(/Mozos:\s*(\d+)/i)?.[1] || null;
  if (mozosNum) addLine(`Mozos: ${mozosNum}`);

  if (c.cantidadCatering) {
    let txt = `Cantidad de platos: ${c.cantidadCatering}`;
    if (precioPlato > 0) txt += ` ‚Äî S/. ${precioPlato.toFixed(2)} cada plato`;
    addLine(txt);
  }

  if (c.platosDescripcion) addLine(`Comida: ${c.platosDescripcion}`);

  const barmanServicios = (c.servicios || []).filter(s =>
    /^(Barman|Ayudante de barra|Barra m√≥vil)$/i.test(s)
  );
  if (barmanServicios.length) addLine(barmanServicios.join(" - "));

 const coctelLineaAmbos = buildCoctelLinea(c);
if (coctelLineaAmbos) addLine(coctelLineaAmbos);



  if (c.extras) addLine(`Notas: ${c.extras}`);

// ===================================================
// TIPO: CATERING
// ===================================================
} else if (c.tipo === "catering") {
  const platosItem = (c.servicios || []).find(s => /^Platos de sitio/i.test(s));
  const servItem   = (c.servicios || []).find(s => /^Servilletas/i.test(s));
  const mesasItem  = (c.servicios || []).find(s => /^Mesas:\s*\d+/i.test(s));

  const platosColor = platosItem?.match(/\(([^)]+)\)/)?.[1] || null;
  const servColor   = servItem?.match(/\(([^)]+)\)/)?.[1] || null;
  const mesasNum    = mesasItem?.match(/Mesas:\s*(\d+)/i)?.[1] || null;

  const l1Parts = [];
  if (platosItem) l1Parts.push(`Platos de sitio${platosColor ? ` (${platosColor})` : ""}`);
  if (servItem)   l1Parts.push(`Servilletas${servColor ? ` (${servColor})` : ""}`);
  if (mesasNum)   l1Parts.push(`Mesas: ${mesasNum}`);
  if (l1Parts.length) addLine(l1Parts.join(" - "));

  const l2Parts = [];
  if ((c.servicios || []).some(s => /^Copas$/i.test(s))) l2Parts.push("Copas");
  if ((c.servicios || []).some(s => /^Cubiertos dorados$/i.test(s))) l2Parts.push("Cubiertos dorados");
  if (l2Parts.length) addLine(l2Parts.join(" - "));

  const mozosItem = (c.servicios || []).find(s => /^Mozos:\s*\d+/i.test(s));
  const mozosNum = mozosItem?.match(/Mozos:\s*(\d+)/i)?.[1] || null;
  if (mozosNum) addLine(`Mozos: ${mozosNum}`);

  if (c.cantidadCatering) {
    let txt = `Cantidad de platos: ${c.cantidadCatering}`;
    if (precioPlato > 0) txt += ` ‚Äî S/. ${precioPlato.toFixed(2)} cada plato`;
    addLine(txt);
  }

  if (c.platosDescripcion) addLine(`Comida: ${c.platosDescripcion}`);
  if (c.extras) addLine(`Notas: ${c.extras}`);

// ===================================================
// TIPO: BARMAN
// ===================================================
} else if (c.tipo === "barman") {
  const barmanServicios = (c.servicios || []).filter(s =>
    /^(Barman|Ayudante de barra|Barra m√≥vil)$/i.test(s)
  );
  if (barmanServicios.length) addLine(barmanServicios.join(" - "));

  // === Cocteles con precios por tipo de vaso + variedades ===
  let coctelLinea = "";
  if (c.cocteles?.modo === "separado") {
    const a = Number(c.cocteles.acrilico || 0);
    const r = Number(c.cocteles.cristaleria || 0);
    coctelLinea = `Cocteles: Acr√≠lico ${a} (S/.3.00 c/u) - Cristaler√≠a ${r} (S/.4.50 c/u)`;
  } else if (c.cocteles?.modo === "total" && Number(c.cocteles.total) > 0) {
    const tipo = (c.cocteles.tipoVajilla || "").trim();
    if (/^acr√≠lico$/i.test(tipo)) {
      coctelLinea = `Cocteles: Acr√≠lico ${Number(c.cocteles.total)} (S/.3.00 c/u)`;
    } else if (/^cristaler√≠a$/i.test(tipo)) {
      coctelLinea = `Cocteles: Cristaler√≠a ${Number(c.cocteles.total)} (S/.4.50 c/u)`;
    } else {
      // si no hay tipo claro, no mostramos
      coctelLinea = "";
    }
  }

  console.log("cocteles =>", JSON.stringify(c.cocteles, null, 2));
console.log("cocteles.variedades =>", c.cocteles?.variedades);
console.log("modo, a, r, total, tipo =>",
  c.cocteles?.modo,
  c.cocteles?.acrilico,
  c.cocteles?.cristaleria,
  c.cocteles?.total,
  c.cocteles?.tipoVajilla
);
console.log("servicios =>", c.servicios);


  const coctelLineaAmbos = buildCoctelLinea(c);
if (coctelLineaAmbos) addLine(coctelLineaAmbos);


  if (c.extras) addLine(`Extras: ${c.extras}`);
}




// Etiqueta Rubros din√°mica y contenido (sin redundancias)
const rubrosLabel = document.getElementById("rubrosLabel");

// Normaliza base recibido desde redactar
let baseRubros = (c.rubrosTexto || "")
  .replace(/^Platos\b/i, "Comida")
  .replace(/^Cocteles y Platos\b/i, "Comida y Cocteles");

// Quita la categor√≠a inicial para no repetirla en el contenido
function stripCategoria(str){
  return str.replace(/^(Comida y Cocteles|Comida|Cocteles)\s*‚Äî\s*/i, "");
}

let contenidoRubros = stripCategoria(baseRubros);

// üö´ Quitar cualquier desglose de cocteles (Acr√≠lico/Cristaler√≠a) en TODOS los casos
contenidoRubros = contenidoRubros
  .replace(/\s*‚Äî\s*\((?:Acr√≠lico|Cristaler√≠a)\)\s*\d+/gi, "")
  .replace(/\s*‚Äî\s*Cocteles:\s*Acr√≠lico\s*\d+\s*\|\s*Cristaler√≠a\s*\d+/gi, "")
  .trim();

// Label visible
let labelText = "Detalle:";
if (c.tipo === "catering")      labelText = "Comida:";
else if (c.tipo === "barman")   labelText = "Cocteles:";
else                            labelText = "Comida + Cocteles:";

rubrosLabel.textContent = labelText;

// En ‚ÄúAmbos‚Äù, imprime la l√≠nea compacta. En otros, el contenido ya saneado.
if (c.tipo === "ambos" && c.totales) {
  document.getElementById("rubros").textContent =
    c.rubrosTexto || `Comida S/. ${n2(c.totales.comida)} + Cocteles S/. ${n2(c.totales.barman)} ‚Äî Total S/. ${n2(c.totales.total)}`;
} else {
  document.getElementById("rubros").textContent = contenidoRubros;
}

      // Totales / evento
      // ---- Movilidad: mostrar monto o esconder la fila ----
        const mobSpan = document.getElementById("movilidad");
        const mobLi   = mobSpan ? mobSpan.closest("li") : null;

        if (c.movOn && Number(c.movilidadMonto) > 0) {
          mobSpan.textContent = `S/. ${Number(c.movilidadMonto).toFixed(2)}`;
        } else {
          // Si no hay movilidad, elimina toda la fila "Movilidad:"
          if (mobLi) mobLi.remove();
        }


      document.getElementById("adelanto").textContent = n2(c.adelanto);
      document.getElementById("resta").textContent   = n2(c.resta);
      // Fecha/hora bonitas con fallback (usa c.fechaTexto / c.hora en AM/PM si vienen)
      const fechaBonita = mayusInicial(c.fechaTexto || formatearFechaISO(c.fecha));
      const horaBonita  = c.horaTexto || formatearHora24(c.hora);

      // Elegir texto seg√∫n tipo
        const sujetoEvento =
          (c.tipo === "barman")
            ? "cocteles"
            : (c.tipo === "catering" ? "platos de comida" : "cocteles y platos de comida");

        // Verbo seg√∫n tipo:
        // - Barman / Ambos (cocteles): "se preparan"
        // - Catering: "se servir√°n"
        const verboEvento = (c.tipo === "catering") ? "se servir√°n" : "se preparan";

        document.getElementById("detalleEvento").innerHTML = `
        <br>
        ${textoHoras}
        el d√≠a <b>${c.fechaTexto}</b> en <b>${c.direccion}</b>
        ${c.referencia ? "(Ref: " + c.referencia + ")" : ""}.
      `;



      // Firmas
      const elRos = document.getElementById("firmaRosario");
      const elSeb = document.getElementById("firmaSebastian");
      const elSuj = document.getElementById("firmaSujey");
      const elCtr = document.getElementById("firmaContratante");
      [elSeb, elSuj, elCtr].forEach(el => el?.classList.add("hidden"));
      elRos?.classList.remove("hidden");

      // Siempre debe firmar el CONTRATANTE
      elCtr?.classList.remove("hidden");
      document.getElementById("nombreContratante").textContent = c.cliente;
      document.getElementById("dniContratante").textContent = c.dniCliente;

      if (c.tipo === "barman") {
        elSeb?.classList.remove("hidden");
      } else if (c.tipo === "catering") {
        if (c.firmaCatering === "Sujey") {
          elSuj?.classList.remove("hidden");
          elRos?.classList.add("hidden");
        }
      } else if (c.tipo === "ambos") {
        elCtr?.classList.remove("hidden");
        document.getElementById("nombreContratante").textContent = c.cliente;
        document.getElementById("dniContratante").textContent = c.dniCliente;
        // Si tambi√©n quieres a Sebasti√°n en "ambos", descomenta:
        // elSeb?.classList.remove("hidden");
      }

      // Fecha de hoy (formato local es-PE)
      const hoyStr = new Intl.DateTimeFormat('es-PE', { year:'numeric', month:'long', day:'numeric' })
                      .format(new Date());
      document.getElementById("fechaActual").textContent = `Huancayo: ${hoyStr}`;


  // === Generar PDF, subirlo a Supabase y guardar en la tabla ===
if (data.autoDownload) {
  try {
    const element = document.getElementById("contrato");

    const pdfWidth  = element.offsetWidth;
    const pdfHeight = element.offsetHeight;

    const opt = {
      margin: 0,
      filename: c.filename || "Contrato.pdf",
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: {
        unit: "px",
        format: [pdfWidth, pdfHeight],
        orientation: "portrait"
      }
    };

    // 1) Generar PDF como blob
    const worker = html2pdf().set(opt).from(element).toPdf();
    const pdf = await worker.get("pdf");
    const blob = pdf.output("blob");

    // 2) Subir PDF a Supabase Storage
    const bucketName = "contratos-pdf";

    // si estoy editando y ya existe un pdf_path, re√∫salo;
    // si no, genero uno nuevo
    const fileName =
      c.filename ||
      `Contrato_${(c.tipo || "general")}_${Date.now()}.pdf`;

    const filePath =
      c.prevPdfPath && typeof c.prevPdfPath === "string"
        ? c.prevPdfPath
        : fileName;

    const { error: upErr } = await supabase
      .storage
      .from(bucketName)
      .upload(filePath, blob, {
        contentType: "application/pdf",
        upsert: true,   // üëà sobrescribe el PDF existente
      });

    if (upErr) {
      console.error("Error subiendo PDF:", upErr);
      alert("Error subiendo el PDF a Supabase: " + upErr.message);
      return;
    } else {
      console.log("PDF subido OK en ruta:", filePath);
    }

    // 3) Guardar registro en la tabla contratos
    const row = {
      tipo: c.tipo,
      cliente: c.cliente,
      dni: c.dniCliente,
      fecha_evento: c.fecha || null,
      direccion: c.direccion || "",
      referencia: c.referencia || "",
      total: c.total || null,
      adelanto: c.adelanto || null,
      resta: c.resta || null,
      pdf_path: filePath,   // mismo que en upload
      filename: fileName,
      payload: c
    };

    let dbErr = null;
    let savedId = c.editingId || null;

    if (c.editingId) {
      // üëá MODO EDICI√ìN: actualiza el registro existente
      const { data: updData, error } = await supabase
        .from("contratos")
        .update(row)
        .eq("id", c.editingId)
        .select("id")
        .maybeSingle();

      dbErr = error;
      if (!error && updData) savedId = updData.id;
    } else {
      // üëá MODO NUEVO: inserta uno nuevo
      const { data: insData, error } = await supabase
        .from("contratos")
        .insert([row])
        .select("id")
        .maybeSingle();

      dbErr = error;
      if (!error && insData) savedId = insData.id;
    }

    if (dbErr) {
      console.error("Error guardando en DB:", dbErr);
      alert("Error guardando el contrato en la base de datos: " + dbErr.message);
    } else {
      window.__lastContratoId = savedId || c.editingId || null;
      console.log(
        c.editingId
          ? "Contrato actualizado en la tabla 'contratos' (ID " + savedId + ")"
          : "Contrato creado en la tabla 'contratos' (ID " + savedId + ")"
      );
    }

    // 4) Descargar el PDF al usuario (como antes)
    try {
      await html2pdf().set(opt).from(element).save();
    } catch (e) {
      console.warn("PDF subido, pero no se descarg√≥ autom√°ticamente:", e);
    }
  } catch (e) {
    console.error("Error generando/subiendo/guardando PDF:", e);
    alert("Error generando o guardando el PDF: " + e.message);
  }{
    // üîµ Cerrar popup de cargando
    closeLoadingPopup();
  }
}});

    // === Variables globales para edici√≥n desde el template ===
    window.__lastContratoId = window.__lastContratoId || null;
    window.__lastPayload = window.__lastPayload || null;

    // Bot√≥n "‚úèÔ∏è Editar este contrato" en contratoTemplate
    function editarContratoDesdeTemplate() {
      const id =
        window.__lastContratoId ||
        (window.__lastPayload && window.__lastPayload.editingId);

      console.log("editarContratoDesdeTemplate() ‚Üí id:", id, "payload:", window.__lastPayload);

      if (!id) {
        alert("A√∫n no se pudo identificar el contrato para editar. Guarda el contrato primero.");
        return;
      }

      // Ir a redactar con ese contrato
      window.location.href = `redactar.html?contratoId=${id}`;
    }

    
  </script>
    
</body>
</html>
